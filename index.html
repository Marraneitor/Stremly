<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streamly ‚Äî Iniciar Sesi√≥n</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∫</text></svg>">

  <!-- Fuentes (swap para carga instant√°nea) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />

  <!-- Lucide Icons -->
  <link rel="stylesheet" href="https://unpkg.com/lucide-static@latest/font/lucide.css" media="print" onload="this.media='all'" />

  <!-- Font Awesome (para iconos de plataformas y WhatsApp) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- DNS Prefetch para APIs -->
  <link rel="dns-prefetch" href="https://www.gstatic.com" />
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

  <!-- Estilos -->
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    /* Icono decorativo del login */
    .login-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--accent), #6d28d9);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      color: #fff;
      box-shadow: var(--shadow-accent);
    }
    .login-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 0.75rem;
    }
    .login-divider::before,
    .login-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-color);
    }
    .login-footer {
      text-align: center;
      margin-top: 20px;
      font-size: 0.8125rem;
      color: var(--text-muted);
    }
    .login-footer a {
      color: var(--accent-light);
      font-weight: 500;
    }
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 1rem;
    }
    .password-toggle:hover {
      color: var(--text-primary);
    }
    .form-group-password {
      position: relative;
    }
    .form-group-password .form-control {
      padding-right: 40px;
    }
    .login-error {
      background: var(--danger-bg);
      color: var(--danger);
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      font-size: 0.8125rem;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 8px;
    }
    .login-error.show {
      display: flex;
    }
  </style>
</head>
<body>

  <!-- ============================================================
       LOGIN PAGE
       ============================================================ -->
  <div class="login-page" id="loginPage">
    <div class="login-container">
      <div class="login-logo">
        <div class="login-icon">
          <i class="fa-solid fa-bolt"></i>
        </div>
        <h1>Streamly</h1>
        <p data-i18n="login.subtitle">Gesti√≥n de cuentas de streaming</p>
      </div>

      <!-- Error message -->
      <div class="login-error" id="loginError">
        <i class="fa-solid fa-circle-exclamation"></i>
        <span id="loginErrorMsg" data-i18n="login.error">Credenciales incorrectas</span>
      </div>

      <!-- Login Form -->
      <form id="loginForm" autocomplete="off">
        <div class="form-group">
          <label for="loginEmail" data-i18n="login.email">Correo electr√≥nico</label>
          <input
            type="email"
            id="loginEmail"
            class="form-control"
            placeholder="tu@email.com"
            data-i18n-ph="login.email_ph"
            autocomplete="username"
            required
          />
        </div>

        <div class="form-group">
          <label for="loginPassword" data-i18n="login.password">Contrase√±a</label>
          <div class="form-group-password">
            <input
              type="password"
              id="loginPassword"
              class="form-control"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
              autocomplete="current-password"
            />
            <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">
              <i class="fa-regular fa-eye"></i>
            </button>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block btn-lg" id="loginBtn" data-i18n="login.submit">
          <i class="fa-solid fa-right-to-bracket"></i>
          Iniciar Sesi√≥n
        </button>
      </form>

      <div class="login-divider" data-i18n="login.divider">o</div>

      <button type="button" class="btn-google" id="googleLoginBtn" onclick="signInWithGoogle()" data-i18n="login.google">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" />
        Continuar con Google
      </button>

      <div class="login-footer">
        <span data-i18n="login.no_account">¬øNo tienes cuenta?</span> <a href="#" id="showRegister" data-i18n="login.register_link">Reg√≠strate aqu√≠</a>
      </div>
    </div>
  </div>

  <!-- ============================================================
       REGISTER PAGE (overlay)
       ============================================================ -->
  <div class="login-page hidden" id="registerPage">
    <div class="login-container">
      <div class="login-logo">
        <div class="login-icon">
          <i class="fa-solid fa-user-plus"></i>
        </div>
        <h1 data-i18n="register.title">Crear Cuenta</h1>
        <p data-i18n="register.subtitle">Configura tu negocio de streaming</p>
      </div>

      <div class="login-error" id="registerError">
        <i class="fa-solid fa-circle-exclamation"></i>
        <span id="registerErrorMsg"></span>
      </div>

      <form id="registerForm" autocomplete="off">
        <div class="form-group">
          <label for="regBusinessName" data-i18n="register.business">Nombre del negocio</label>
          <input
            type="text"
            id="regBusinessName"
            class="form-control"
            placeholder="Ej: StreamPlus"
            data-i18n-ph="register.business_ph"
            required
          />
        </div>

        <div class="form-group">
          <label for="regEmail" data-i18n="login.email">Correo electr√≥nico</label>
          <input
            type="email"
            id="regEmail"
            class="form-control"
            placeholder="tu@email.com"
            data-i18n-ph="login.email_ph"
            autocomplete="username"
            required
          />
        </div>

        <div class="form-group">
          <label for="regPassword" data-i18n="login.password">Contrase√±a</label>
          <div class="form-group-password">
            <input
              type="password"
              id="regPassword"
              class="form-control"
              placeholder="M√≠nimo 6 caracteres"
              data-i18n-ph="register.password_ph"
              required
              minlength="6"
              autocomplete="new-password"
            />
            <button type="button" class="password-toggle" onclick="togglePassword('regPassword', this)">
              <i class="fa-regular fa-eye"></i>
            </button>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block btn-lg" id="registerBtn" data-i18n="register.submit">
          <i class="fa-solid fa-user-plus"></i>
          Crear Cuenta
        </button>
      </form>

      <div class="login-divider" data-i18n="login.divider">o</div>

      <button type="button" class="btn-google" id="googleRegisterBtn" onclick="signInWithGoogle()" data-i18n="register.google">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" />
        Registrarse con Google
      </button>

      <div class="login-footer">
        <span data-i18n="register.has_account">¬øYa tienes cuenta?</span> <a href="#" id="showLogin" data-i18n="register.login_link">Inicia sesi√≥n</a>
      </div>
    </div>
  </div>

  <!-- ============================================================
       MAIN APP (oculto hasta login)
       ============================================================ -->
  <div class="app-layout hidden" id="appLayout">
    <!-- Overlay para sidebar mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1><i class="fa-solid fa-bolt"></i> Streamly</h1>
        <span data-i18n="sidebar.subtitle">Gesti√≥n Streaming</span>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section-title" data-i18n="sidebar.main">Principal</div>
        <button class="nav-item active" data-section="dashboard" onclick="navigateTo('dashboard')" data-i18n="sidebar.dashboard">
          <i class="fa-solid fa-chart-pie"></i>
          Dashboard
        </button>
        <button class="nav-item" data-section="cuentas" onclick="navigateTo('cuentas')" data-i18n="sidebar.accounts">
          <i class="fa-solid fa-tv"></i>
          Cuentas
        </button>
        <button class="nav-item" data-section="clientes" onclick="navigateTo('clientes')" data-i18n="sidebar.clients">
          <i class="fa-solid fa-users"></i>
          Clientes
          <span class="badge badge-warning" id="navOrdersBadge" style="margin-left: auto; display: none; font-size: 0.65rem; padding: 2px 6px;"></span>
        </button>
        <button class="nav-item" data-section="movimientos" onclick="navigateTo('movimientos')" data-i18n="sidebar.movements">
          <i class="fa-solid fa-money-bill-transfer"></i>
          Movimientos
        </button>

        <div class="nav-section-title" style="margin-top: 16px;" data-i18n="sidebar.tools">Herramientas</div>
        <button class="nav-item" data-section="reportes" onclick="navigateTo('reportes')" data-i18n="sidebar.reports">
          <i class="fa-solid fa-chart-bar"></i>
          Reportes
        </button>
        <button class="nav-item" data-section="calendario" onclick="navigateTo('calendario')" data-i18n="sidebar.calendar">
          <i class="fa-solid fa-calendar-days"></i>
          Calendario
        </button>
        <button class="nav-item" data-section="deudores" onclick="navigateTo('deudores')" data-i18n="sidebar.debtors">
          <i class="fa-solid fa-file-invoice-dollar"></i>
          Deudores
        </button>
        <button class="nav-item" data-section="plantillas" onclick="navigateTo('plantillas')" data-i18n="sidebar.templates">
          <i class="fa-solid fa-envelope-open-text"></i>
          Plantillas
        </button>
        <button class="nav-item" data-section="logs" onclick="navigateTo('logs')" data-i18n="sidebar.logs">
          <i class="fa-solid fa-clipboard-list"></i>
          Actividad
        </button>
        <button class="nav-item" data-section="chatbot" onclick="navigateTo('chatbot')" data-i18n="sidebar.chatbot">
          <i class="fa-brands fa-whatsapp"></i>
          Chatbot IA
        </button>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-user" id="sidebarUser">
          <div class="sidebar-user-avatar" id="userAvatar">A</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name" id="userName">Admin</div>
            <div class="sidebar-user-email" id="userEmail">admin@email.com</div>
          </div>
        </div>
        <button class="btn-signout" onclick="signOut()" data-i18n="sidebar.logout">
          <i class="fa-solid fa-arrow-right-from-bracket"></i>
          Cerrar Sesi√≥n
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <!-- Top Header -->
      <header class="top-header">
        <div class="header-left">
          <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
          </button>
          <h2 class="page-title" id="pageTitle">Dashboard</h2>
        </div>
        <div class="header-right">
          <!-- Language Selector -->
          <div class="lang-selector">
            <button class="lang-toggle-btn" id="langToggleBtn" onclick="toggleLangDropdown()">
              <i class="fa-solid fa-globe"></i>
              <span id="langCurrentLabel">ES</span>
              <i class="fa-solid fa-chevron-down" style="font-size:0.6rem;"></i>
            </button>
            <div id="langDropdown" class="lang-dropdown">
              <button class="lang-option active" data-lang="es" onclick="setLanguage('es')">
                üá≤üáΩ Espa√±ol
              </button>
              <button class="lang-option" data-lang="en" onclick="setLanguage('en')">
                üá∫üá∏ English
              </button>
              <button class="lang-option" data-lang="pt" onclick="setLanguage('pt')">
                üáßüá∑ Portugu√™s
              </button>
              <button class="lang-option" data-lang="fr" onclick="setLanguage('fr')">
                üá´üá∑ Fran√ßais
              </button>
            </div>
          </div>
          <!-- Currency Selector -->
          <div class="currency-selector">
            <select id="currencySelect" onchange="setCurrency(this.value)" class="currency-select">
              <option value="COP">COP $</option>
              <option value="USD">USD $</option>
              <option value="EUR">EUR ‚Ç¨</option>
              <option value="MXN">MXN $</option>
              <option value="ARS">ARS $</option>
              <option value="BRL">BRL R$</option>
              <option value="PEN">PEN S/</option>
              <option value="CLP">CLP $</option>
            </select>
          </div>
          <!-- Theme Toggle -->
          <button class="theme-toggle-btn" onclick="toggleTheme()" title="Modo claro/oscuro">
            <i class="fa-solid fa-sun" id="themeIcon"></i>
          </button>
          <span class="header-date" id="headerDate"></span>
          <button class="btn btn-primary btn-sm" id="headerAddBtn" onclick="openQuickAdd()" data-i18n="header.new">
            <i class="fa-solid fa-plus"></i>
            Nuevo
          </button>
        </div>
      </header>

      <!-- Page Content -->
      <div class="page-content">
        <!-- ==================== DASHBOARD ==================== -->
        <div class="section active" id="section-dashboard">
          <!-- Stats Cards -->
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon purple">
                  <i class="fa-solid fa-dollar-sign"></i>
                </div>
              </div>
              <div class="stat-card-value" id="statBalance">$0.00</div>
              <div class="stat-card-label" data-i18n="dash.balance">Balance Total del Mes</div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon green">
                  <i class="fa-solid fa-user-check"></i>
                </div>
              </div>
              <div class="stat-card-value" id="statActiveClients">0</div>
              <div class="stat-card-label" data-i18n="dash.active_clients">Clientes Activos</div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon red">
                  <i class="fa-solid fa-user-xmark"></i>
                </div>
              </div>
              <div class="stat-card-value" id="statExpiredClients">0</div>
              <div class="stat-card-label" data-i18n="dash.expired_clients">Clientes Vencidos</div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon blue">
                  <i class="fa-solid fa-tv"></i>
                </div>
              </div>
              <div class="stat-card-value" id="statTotalAccounts">0</div>
              <div class="stat-card-label" data-i18n="dash.total_accounts">Cuentas Registradas</div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon yellow">
                  <i class="fa-solid fa-clock"></i>
                </div>
              </div>
              <div class="stat-card-value" id="statExpiringSoon">0</div>
              <div class="stat-card-label" data-i18n="dash.expiring_soon">Vence en ‚â§ 3 d√≠as</div>
            </div>
          </div>

          <!-- Charts Row -->
          <div class="charts-row">
            <div class="chart-card">
              <h4><i class="fa-solid fa-chart-line"></i> <span data-i18n="dash.income_chart">Ingresos Mensuales</span></h4>
              <canvas id="chartIncome" height="220"></canvas>
            </div>
            <div class="chart-card">
              <h4><i class="fa-solid fa-users"></i> <span data-i18n="dash.clients_chart">Clientes Activos vs Vencidos</span></h4>
              <canvas id="chartClients" height="220"></canvas>
            </div>
            <div class="chart-card">
              <h4><i class="fa-solid fa-tv"></i> <span data-i18n="dash.platform_chart">Ocupaci√≥n por Plataforma</span></h4>
              <canvas id="chartPlatforms" height="220"></canvas>
            </div>
          </div>

          <!-- Profit Calculator -->
          <div class="table-container" style="margin-bottom: 20px;">
            <div class="table-header">
              <h3><i class="fa-solid fa-calculator"></i> <span data-i18n="dash.profit_calc">Calculadora de Ganancias</span></h3>
            </div>
            <div class="profit-grid" id="profitGrid">
              <div class="profit-card income">
                <i class="fa-solid fa-arrow-trend-up"></i>
                <span class="profit-label" data-i18n="dash.gross_income">Ingreso Bruto</span>
                <span class="profit-value" id="profitGross">$0</span>
              </div>
              <div class="profit-card expense">
                <i class="fa-solid fa-arrow-trend-down"></i>
                <span class="profit-label" data-i18n="dash.total_cost">Costo Cuentas</span>
                <span class="profit-value" id="profitCost">$0</span>
              </div>
              <div class="profit-card net">
                <i class="fa-solid fa-coins"></i>
                <span class="profit-label" data-i18n="dash.net_profit">Ganancia Neta</span>
                <span class="profit-value" id="profitNet">$0</span>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="quick-actions">
            <button class="quick-action-btn" onclick="openModal('accountModal')" data-i18n="dash.new_account">
              <i class="fa-solid fa-plus-circle"></i>
              Nueva Cuenta
            </button>
            <button class="quick-action-btn" onclick="openNewClientModal()" data-i18n="dash.add_client">
              <i class="fa-solid fa-user-plus"></i>
              Agregar Cliente
            </button>
            <button class="quick-action-btn" onclick="openModal('movementModal')" data-i18n="dash.register_payment">
              <i class="fa-solid fa-receipt"></i>
              Registrar Pago
            </button>
          </div>

          <!-- Recent Clients Table -->
          <div class="table-container">
            <div class="table-header">
              <h3 data-i18n="dash.expiring_title"><i class="fa-solid fa-clock-rotate-left"></i> Clientes Pr√≥ximos a Vencer</h3>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.client">Cliente</th>
                    <th data-i18n="th.platform">Plataforma</th>
                    <th data-i18n="th.profile">Perfil</th>
                    <th data-i18n="th.expiry">Vencimiento</th>
                    <th data-i18n="th.days_left">D√≠as Rest.</th>
                    <th data-i18n="th.status">Estado</th>
                    <th data-i18n="th.actions">Acciones</th>
                  </tr>
                </thead>
                <tbody id="dashboardClientsBody">
                  <tr>
                    <td colspan="7" class="table-empty">
                      <i class="fa-solid fa-inbox"></i>
                      <p data-i18n="dash.no_clients">No hay clientes registrados a√∫n</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ==================== CUENTAS ==================== -->
        <div class="section" id="section-cuentas">
          <div class="table-container">
            <div class="table-header">
              <h3 data-i18n="accounts.title"><i class="fa-solid fa-tv"></i> Cuentas de Streaming</h3>
              <div class="table-actions">
                <div class="search-input-wrapper">
                  <i class="fa-solid fa-search"></i>
                  <input type="text" class="search-input" placeholder="Buscar cuenta..." data-i18n-ph="accounts.search_ph" id="searchAccounts" oninput="debouncedFilterAccounts()" />
                </div>
                <button class="btn btn-primary btn-sm" onclick="openModal('accountModal')" data-i18n="accounts.new">
                  <i class="fa-solid fa-plus"></i>
                  Nueva Cuenta
                </button>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.platform">Plataforma</th>
                    <th data-i18n="th.credentials">Credenciales</th>
                    <th data-i18n="th.profiles">Perfiles</th>
                    <th data-i18n="th.price_profile">$/Perfil</th>
                    <th data-i18n="th.master_expiry">Vencimiento M√°ster</th>
                    <th data-i18n="th.days_left">D√≠as Rest.</th>
                    <th data-i18n="th.status">Estado</th>
                    <th data-i18n="th.actions">Acciones</th>
                  </tr>
                </thead>
                <tbody id="accountsTableBody">
                  <tr>
                    <td colspan="8" class="table-empty">
                      <i class="fa-solid fa-tv"></i>
                      <p data-i18n="accounts.empty">Agrega tu primera cuenta de streaming</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ==================== CLIENTES ==================== -->
        <div class="section" id="section-clientes">

          <!-- Pedidos Pendientes (desde el chatbot) -->
          <div class="table-container" id="pendingOrdersContainer" style="display:none; margin-bottom: 24px;">
            <div class="table-header">
              <h3 data-i18n="clients.pending_orders"><i class="fa-solid fa-bell" style="color: var(--warning);"></i> Pedidos Pendientes <span class="badge badge-warning" id="pendingOrdersCount" style="margin-left: 8px;">0</span></h3>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.number">#</th>
                    <th data-i18n="th.client">Cliente</th>
                    <th data-i18n="th.phone">Tel√©fono</th>
                    <th data-i18n="th.platform">Plataforma</th>
                    <th data-i18n="th.qty">Cant.</th>
                    <th data-i18n="th.date">Fecha</th>
                    <th data-i18n="th.status">Estado</th>
                    <th data-i18n="th.actions">Acciones</th>
                  </tr>
                </thead>
                <tbody id="pendingOrdersBody">
                  <tr>
                    <td colspan="8" class="table-empty">
                      <i class="fa-solid fa-inbox"></i>
                      <p data-i18n="clients.no_pending">No hay pedidos pendientes</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="table-container">
            <div class="table-header">
              <h3 data-i18n="clients.title"><i class="fa-solid fa-users"></i> Clientes</h3>
              <div class="table-actions">
                <div class="search-input-wrapper">
                  <i class="fa-solid fa-search"></i>
                  <input type="text" class="search-input" placeholder="Buscar cliente..." data-i18n-ph="clients.search_ph" id="searchClients" oninput="debouncedFilterClients()" />
                </div>
                <button class="btn btn-primary btn-sm" onclick="openNewClientModal()" data-i18n="clients.new">
                  <i class="fa-solid fa-user-plus"></i>
                  Nuevo Cliente
                </button>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.client">Cliente</th>
                    <th data-i18n="th.whatsapp">WhatsApp</th>
                    <th data-i18n="th.platform">Plataforma</th>
                    <th data-i18n="th.profile_pin">Perfil / PIN</th>
                    <th data-i18n="th.price">Precio</th>
                    <th data-i18n="th.start">Inicio</th>
                    <th data-i18n="th.end">Fin</th>
                    <th data-i18n="th.days_left">D√≠as Rest.</th>
                    <th data-i18n="th.status">Estado</th>
                    <th data-i18n="th.payment">Pago</th>
                    <th data-i18n="th.actions">Acciones</th>
                  </tr>
                </thead>
                <tbody id="clientsTableBody">
                  <tr>
                    <td colspan="11" class="table-empty">
                      <i class="fa-solid fa-users"></i>
                      <p data-i18n="clients.empty">Agrega tu primer cliente</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ==================== MOVIMIENTOS ==================== -->
        <div class="section" id="section-movimientos">
          <div class="table-container">
            <div class="table-header">
              <h3 data-i18n="movements.title"><i class="fa-solid fa-money-bill-transfer"></i> Movimientos</h3>
              <div class="table-actions">
                <div class="search-input-wrapper">
                  <i class="fa-solid fa-search"></i>
                  <input type="text" class="search-input" placeholder="Buscar movimiento..." data-i18n-ph="movements.search_ph" id="searchMovements" oninput="debouncedFilterMovements()" />
                </div>
                <button class="btn btn-primary btn-sm" onclick="openModal('movementModal')" data-i18n="movements.new">
                  <i class="fa-solid fa-plus"></i>
                  Nuevo Movimiento
                </button>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.date">Fecha</th>
                    <th data-i18n="th.client">Cliente</th>
                    <th data-i18n="th.amount">Monto</th>
                    <th data-i18n="th.method">M√©todo</th>
                    <th data-i18n="th.note">Nota</th>
                    <th data-i18n="th.actions">Acciones</th>
                  </tr>
                </thead>
                <tbody id="movementsTableBody">
                  <tr>
                    <td colspan="6" class="table-empty">
                      <i class="fa-solid fa-receipt"></i>
                      <p data-i18n="movements.empty">No hay movimientos registrados</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ==================== CALENDARIO ==================== -->
        <div class="section" id="section-calendario">
          <div class="table-container">
            <div class="table-header">
              <h3><i class="fa-solid fa-calendar-days"></i> <span data-i18n="calendar.title">Calendario de Vencimientos</span></h3>
              <div class="table-actions">
                <button class="btn btn-secondary btn-sm" onclick="calendarPrev()">
                  <i class="fa-solid fa-chevron-left"></i>
                </button>
                <span id="calendarMonthLabel" style="font-weight:600;min-width:140px;text-align:center;"></span>
                <button class="btn btn-secondary btn-sm" onclick="calendarNext()">
                  <i class="fa-solid fa-chevron-right"></i>
                </button>
                <button class="btn btn-secondary btn-sm" onclick="calendarToday()" data-i18n="calendar.today" style="margin-left:8px;">
                  Hoy
                </button>
              </div>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
            <div class="calendar-legend">
              <span><i class="fa-solid fa-circle" style="color:var(--success);font-size:8px;"></i> <span data-i18n="calendar.active">Activo</span></span>
              <span><i class="fa-solid fa-circle" style="color:var(--warning);font-size:8px;"></i> <span data-i18n="calendar.expiring">Por vencer</span></span>
              <span><i class="fa-solid fa-circle" style="color:var(--danger);font-size:8px;"></i> <span data-i18n="calendar.expired">Vencido</span></span>
            </div>
          </div>
        </div>

        <!-- ==================== DEUDORES ==================== -->
        <div class="section" id="section-deudores">
          <div class="table-container">
            <div class="table-header">
              <h3><i class="fa-solid fa-file-invoice-dollar"></i> <span data-i18n="debtors.title">Clientes con Cobro Pendiente</span></h3>
              <div class="table-actions">
                <button class="btn btn-primary btn-sm" onclick="sendBulkReminders()">
                  <i class="fa-brands fa-whatsapp"></i>
                  <span data-i18n="debtors.send_all">Enviar cobro a todos</span>
                </button>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.client">Cliente</th>
                    <th data-i18n="th.platform">Plataforma</th>
                    <th data-i18n="th.expiry">Vencimiento</th>
                    <th data-i18n="debtors.days_overdue">D√≠as de Mora</th>
                    <th data-i18n="th.price">Precio</th>
                    <th data-i18n="th.payment">Pago</th>
                    <th data-i18n="th.actions">Acciones</th>
                  </tr>
                </thead>
                <tbody id="debtorsTableBody">
                  <tr>
                    <td colspan="7" class="table-empty">
                      <i class="fa-solid fa-face-smile"></i>
                      <p data-i18n="debtors.empty">¬°No hay deudores! Todos al d√≠a</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ==================== PLANTILLAS ==================== -->
        <div class="section" id="section-plantillas">
          <div class="table-container">
            <div class="table-header">
              <h3><i class="fa-solid fa-envelope-open-text"></i> <span data-i18n="templates.title">Plantillas de Mensajes</span></h3>
              <button class="btn btn-primary btn-sm" onclick="addTemplate()">
                <i class="fa-solid fa-plus"></i>
                <span data-i18n="templates.new">Nueva Plantilla</span>
              </button>
            </div>
            <div class="templates-info" style="padding:12px 20px;color:var(--text-muted);font-size:0.85rem;">
              <i class="fa-solid fa-info-circle"></i>
              <span data-i18n="templates.vars_info">Variables disponibles: {nombre}, {plataforma}, {perfil}, {precio}, {vencimiento}, {dias_mora}</span>
            </div>
            <div id="templatesList" class="templates-list"></div>
          </div>
        </div>

        <!-- ==================== LOGS ==================== -->
        <div class="section" id="section-logs">
          <div class="table-container">
            <div class="table-header">
              <h3><i class="fa-solid fa-clipboard-list"></i> <span data-i18n="logs.title">Registro de Actividad</span></h3>
              <div class="table-actions">
                <button class="btn btn-secondary btn-sm" onclick="clearActivityLogs()">
                  <i class="fa-solid fa-trash"></i>
                  <span data-i18n="logs.clear">Limpiar</span>
                </button>
                <button class="btn btn-primary btn-sm" onclick="exportBackupJSON()">
                  <i class="fa-solid fa-download"></i>
                  <span data-i18n="logs.backup">Descargar Backup</span>
                </button>
              </div>
            </div>
            <div id="activityLogsList" class="activity-logs-list"></div>
          </div>
        </div>

        <!-- ==================== REPORTES ==================== -->
        <div class="section" id="section-reportes">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon purple">
                  <i class="fa-solid fa-calendar"></i>
                </div>
              </div>
              <div class="stat-card-value" id="reportMonthlyIncome">$0.00</div>
              <div class="stat-card-label" data-i18n="reports.monthly_income">Ingresos del Mes</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon green">
                  <i class="fa-solid fa-percent"></i>
                </div>
              </div>
              <div class="stat-card-value" id="reportOccupancy">0%</div>
              <div class="stat-card-label" data-i18n="reports.occupancy">Ocupaci√≥n de Perfiles</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon blue">
                  <i class="fa-solid fa-ranking-star"></i>
                </div>
              </div>
              <div class="stat-card-value" id="reportTopPlatform">‚Äî</div>
              <div class="stat-card-label" data-i18n="reports.top_platform">Plataforma Top</div>
            </div>
          </div>

          <!-- Tabla de resumen por plataforma -->
          <div class="table-container" style="margin-top:-10px;">
            <div class="table-header">
              <h3 data-i18n="reports.summary"><i class="fa-solid fa-chart-bar"></i> Resumen por Plataforma</h3>
              <div class="table-actions">
                <button class="btn btn-secondary btn-sm" onclick="exportCSV('clientes')">
                  <i class="fa-solid fa-file-csv"></i> Clientes CSV
                </button>
                <button class="btn btn-secondary btn-sm" onclick="exportCSV('movimientos')">
                  <i class="fa-solid fa-file-csv"></i> Mov. CSV
                </button>
                <button class="btn btn-primary btn-sm" onclick="exportPDF()">
                  <i class="fa-solid fa-file-pdf"></i> Reporte PDF
                </button>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="th.platform">Plataforma</th>
                    <th data-i18n="th.accounts">Cuentas</th>
                    <th data-i18n="th.total_profiles">Perfiles Totales</th>
                    <th data-i18n="th.occupied">Perfiles Ocupados</th>
                    <th data-i18n="th.available">Disponibles</th>
                    <th data-i18n="th.occupancy">Ocupaci√≥n</th>
                  </tr>
                </thead>
                <tbody id="reportTableBody">
                  <tr>
                    <td colspan="6" class="table-empty">
                      <i class="fa-solid fa-chart-bar"></i>
                      <p data-i18n="reports.empty">Agrega cuentas y clientes para ver reportes</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ==================== CHATBOT ==================== -->
        <div class="section" id="section-chatbot">
          <!-- Estado del Bot -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon green">
                  <i class="fa-brands fa-whatsapp"></i>
                </div>
              </div>
              <div class="stat-card-value" id="botStatus" data-i18n="bot.disconnected">Desconectado</div>
              <div class="stat-card-label" data-i18n="bot.status">Estado del Bot</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon purple">
                  <i class="fa-solid fa-message"></i>
                </div>
              </div>
              <div class="stat-card-value" id="botMessagesCount">0</div>
              <div class="stat-card-label" data-i18n="bot.messages_today">Mensajes Hoy</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-icon blue">
                  <i class="fa-solid fa-robot"></i>
                </div>
              </div>
              <div class="stat-card-value" id="botModelName">Gemini 2 Flash</div>
              <div class="stat-card-label" data-i18n="bot.ai_model">Modelo IA</div>
            </div>
          </div>

          <!-- Configuraci√≥n del Contexto -->
          <div class="table-container">
            <div class="table-header">
              <h3 data-i18n="bot.config_title"><i class="fa-solid fa-wand-magic-sparkles"></i> Configuraci√≥n del Chatbot</h3>
            </div>
            <div style="padding: 20px;">
              <form id="chatbotConfigForm" onsubmit="saveChatbotConfig(event)">

                <div class="form-group">
                  <label for="botContext"><i class="fa-solid fa-brain"></i> Contexto del Bot</label>
                  <div class="bot-context-help">
                    <p><i class="fa-solid fa-circle-info"></i> Escribe aqu√≠ TODO lo que el bot necesita saber para atender a tus clientes. Entre m√°s detallado sea, mejor atender√°.</p>
                  </div>
                  <textarea id="botContext" class="form-control" rows="14" placeholder="Ejemplo:

üè™ PRESENTACI√ìN:
Soy StreamPlus, un asistente de ventas de cuentas de streaming. Me presento de forma amigable y uso emojis con moderaci√≥n. Mi horario de atenci√≥n es 24/7.

üìã DATOS QUE DEBO PEDIR AL CLIENTE:
- Nombre completo
- N√∫mero de WhatsApp
- Qu√© plataforma/cuenta desea

üí∞ PRECIOS DE PERFILES:
- Netflix: $50/mes
- Disney+: $35/mes
- Spotify: $25/mes
- HBO Max: $40/mes
- Amazon Prime: $30/mes

üëã MENSAJE DE BIENVENIDA: 
¬°Hola! üëã Bienvenido a StreamPlus. Tenemos los mejores precios en cuentas de streaming. ¬øEn qu√© te puedo ayudar?

‚ö†Ô∏è SI NO S√â RESPONDER: 
Disculpa, no tengo esa informaci√≥n. Un agente te atender√° pronto.

üìù INSTRUCCIONES ADICIONALES:
- No compartir contrase√±as ni credenciales
- Ser breve y directo (m√°ximo 3-4 l√≠neas por mensaje)
- Si el cliente confirma la compra, pedir sus datos para procesar el pedido"></textarea>
                  <button type="button" class="btn btn-ai-improve" onclick="improveContextWithAI()" id="btnImproveContext">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Mejorar con IA
                  </button>
                </div>

                <div class="form-row" style="margin-top: 16px;">
                  <div class="form-group">
                    <label for="botEnabled" data-i18n="bot.enabled"><i class="fa-solid fa-power-off"></i> Estado del Bot</label>
                    <select id="botEnabled" class="form-control">
                      <option value="true" data-i18n="bot.enabled_on">Activado</option>
                      <option value="false" data-i18n="bot.enabled_off">Desactivado</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="botMaxTokens" data-i18n="bot.max_tokens"><i class="fa-solid fa-gauge"></i> Largo m√°ximo de respuesta</label>
                    <select id="botMaxTokens" class="form-control">
                      <option value="256" data-i18n="bot.tokens_short">Corta (256 tokens)</option>
                      <option value="512" selected data-i18n="bot.tokens_medium">Media (512 tokens)</option>
                      <option value="1024" data-i18n="bot.tokens_long">Larga (1024 tokens)</option>
                    </select>
                  </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 16px;">
                  <button type="submit" class="btn btn-primary" data-i18n="bot.save_config">
                    <i class="fa-solid fa-floppy-disk"></i> Guardar Configuraci√≥n
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="testChatbot()" data-i18n="bot.test_bot">
                    <i class="fa-solid fa-flask"></i> Probar Bot
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Conexi√≥n WhatsApp -->
          <div class="table-container" style="margin-top: 20px;">
            <div class="table-header">
              <h3 data-i18n="wa.title"><i class="fa-brands fa-whatsapp"></i> Conexi√≥n WhatsApp</h3>
              <div class="table-actions">
                <div class="bot-status-bar-mini">
                  <div class="bot-status-indicator disconnected" id="botStatusDot"></div>
                  <span id="botConnectionStatus" data-i18n="bot.disconnected">Desconectado</span>
                </div>
              </div>
            </div>
            <div style="padding: 20px;">
              <div class="bot-connection-panel">

                <!-- Estado inicial: conectando autom√°ticamente -->
                <div class="bot-auto-connecting" id="botAutoConnecting" style="display:none;">
                  <div class="bot-loading-spinner"><i class="fa-solid fa-spinner fa-spin-pulse" style="font-size:2rem; color:var(--accent-light);"></i></div>
                  <p style="color:var(--text-muted); margin:12px 0 0; text-align:center;" data-i18n="wa.connecting">Conectando al servidor del bot...</p>
                </div>

                <!-- Estado inactivo: esperando conexi√≥n -->
                <div class="bot-connection-error" id="botConnectionError">
                  <div style="text-align:center; padding:20px;">
                    <i class="fa-brands fa-whatsapp" style="font-size:2.5rem; color:var(--text-muted); margin-bottom:12px;"></i>
                    <h4 style="color:var(--text-primary); margin:0 0 8px;" data-i18n="wa.bot_title">Bot de WhatsApp</h4>
                    <p style="color:var(--text-muted); font-size:0.85rem; margin:0 0 16px;" data-i18n="wa.bot_desc">Conecta al servidor para vincular tu WhatsApp</p>
                    <button class="btn btn-primary btn-sm" onclick="connectBotServer()" id="botRetryBtn" data-i18n="wa.connect">
                      <i class="fa-solid fa-plug"></i> Conectar
                    </button>
                  </div>
                  <!-- URL avanzada -->
                  <details class="bot-advanced-settings">
                    <summary data-i18n="wa.advanced"><i class="fa-solid fa-gear"></i> Ajustes avanzados</summary>
                    <div style="padding:12px 0 0;">
                      <label style="font-size:0.8rem; color:var(--text-muted); margin-bottom:4px; display:block;" data-i18n="wa.url_label">URL del servidor del bot</label>
                      <div style="display:flex; gap:8px;">
                        <input type="text" id="botServerUrl" class="form-control" placeholder="https://tu-bot.up.railway.app" value="" style="flex:1;" />
                        <button class="btn btn-primary btn-sm" onclick="saveBotUrl(); connectBotServer()" data-i18n="wa.connect">
                          <i class="fa-solid fa-plug"></i> Conectar
                        </button>
                      </div>
                    </div>
                  </details>
                </div>

                <!-- QR Code (protagonista) -->
                <div class="bot-qr-container" id="botQrContainer" style="display:none;">
                  <div class="bot-qr-header">
                    <i class="fa-brands fa-whatsapp" style="font-size:1.5rem; color:var(--whatsapp);"></i>
                    <div>
                      <h4 style="margin:0; color:var(--text-primary); font-size:1rem;" data-i18n="wa.link_title">Vincula tu WhatsApp</h4>
                      <p style="margin:0; color:var(--text-muted); font-size:0.8rem;" data-i18n="wa.link_desc">Escanea el c√≥digo QR para activar el bot</p>
                    </div>
                  </div>
                  <div class="bot-qr-code" id="botQrCode"></div>
                  <div class="bot-qr-steps">
                    <div class="bot-qr-step" data-i18n="wa.step1" data-i18n-html><span>1</span> Abre <strong>WhatsApp</strong> en tu tel√©fono</div>
                    <div class="bot-qr-step" data-i18n="wa.step2" data-i18n-html><span>2</span> Toca <strong>Dispositivos vinculados</strong></div>
                    <div class="bot-qr-step" data-i18n="wa.step3" data-i18n-html><span>3</span> Escanea este <strong>c√≥digo QR</strong></div>
                  </div>
                  <button class="btn btn-sm" onclick="resetBotSession()" id="botResetQrBtn" style="margin-top:12px; background: var(--bg-secondary); color: var(--text-muted); border: 1px solid var(--border-color);" data-i18n="wa.new_qr">
                    <i class="fa-solid fa-rotate"></i> Generar nuevo QR
                  </button>
                </div>

                <!-- Conectado -->
                <div class="bot-connected-info" id="botConnectedInfo" style="display:none;">
                  <div class="bot-connected-icon">
                    <i class="fa-brands fa-whatsapp"></i>
                  </div>
                  <h4 data-i18n="wa.connected_title">Bot conectado y activo</h4>
                  <p id="botPhoneNumber" data-i18n="wa.connected_desc">Respondiendo mensajes autom√°ticamente</p>
                  <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
                    <button class="btn btn-sm" id="botPauseBtn" onclick="toggleGlobalPause()" style="background: var(--warning); color: #000;" data-i18n="wa.pause">
                      <i class="fa-solid fa-pause"></i> Pausar Respuestas
                    </button>
                    <button class="btn btn-sm" onclick="resetBotSession()" id="botResetBtn" style="background: var(--bg-secondary); color: var(--text-muted); border: 1px solid var(--border-color);" data-i18n="wa.new_qr_btn">
                      <i class="fa-solid fa-rotate"></i> Nuevo QR
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="disconnectBotServer()" id="botDisconnectBtn" data-i18n="wa.disconnect">
                      <i class="fa-solid fa-stop"></i> Desconectar
                    </button>
                  </div>
                </div>

                <!-- Logs (colapsable) -->
                <details class="bot-logs-details" id="botLogs" style="display:none;">
                  <summary style="cursor:pointer; font-size:0.8rem; color:var(--text-muted); padding:8px 0;" data-i18n="wa.view_logs"><i class="fa-solid fa-terminal"></i> Ver logs del bot</summary>
                  <div class="bot-logs-content" id="botLogsContent"></div>
                </details>
              </div>
            </div>
          </div>

          <!-- Ajustes de Mensajer√≠a -->
          <div class="table-container" style="margin-top: 20px;">
            <div class="table-header">
              <h3 data-i18n="filters.title"><i class="fa-solid fa-filter"></i> Filtros de Mensajer√≠a</h3>
            </div>
            <div style="padding: 20px;">
              <div class="bot-settings-grid">
                <label class="bot-toggle-card">
                  <div class="bot-toggle-info">
                    <i class="fa-solid fa-people-group"></i>
                    <div>
                      <strong data-i18n="filters.groups">Grupos de WhatsApp</strong>
                      <small data-i18n="filters.groups_desc">Responder autom√°ticamente en grupos</small>
                    </div>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="settingRespondGroups" onchange="saveBotSettings()">
                    <span class="slider"></span>
                  </label>
                </label>
                <label class="bot-toggle-card">
                  <div class="bot-toggle-info">
                    <i class="fa-solid fa-address-book"></i>
                    <div>
                      <strong data-i18n="filters.saved">Contactos Guardados</strong>
                      <small data-i18n="filters.saved_desc">Responder a contactos con nombre</small>
                    </div>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="settingRespondSaved" checked onchange="saveBotSettings()">
                    <span class="slider"></span>
                  </label>
                </label>
                <label class="bot-toggle-card">
                  <div class="bot-toggle-info">
                    <i class="fa-solid fa-user-question"></i>
                    <div>
                      <strong data-i18n="filters.unsaved">Contactos No Guardados</strong>
                      <small data-i18n="filters.unsaved_desc">Responder a n√∫meros desconocidos</small>
                    </div>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="settingRespondUnsaved" checked onchange="saveBotSettings()">
                    <span class="slider"></span>
                  </label>
                </label>
              </div>
            </div>
          </div>

          <!-- Cuentas Disponibles -->
          <div class="table-container" style="margin-top: 20px;">
            <div class="table-header">
              <h3 data-i18n="inventory.title"><i class="fa-solid fa-shop"></i> Inventario para Venta (Bot)</h3>
              <button class="btn btn-secondary btn-sm" onclick="loadAvailableAccounts()" data-i18n="common.update">
                <i class="fa-solid fa-rotate"></i> Actualizar
              </button>
            </div>
            <div style="padding: 20px;">
              <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;" data-i18n="inventory.desc">
                El bot ofrecer√° autom√°ticamente solo las plataformas con disponibilidad. No compartir√° credenciales hasta confirmar pago.
              </p>
              <div id="availableAccountsList" class="available-accounts-grid">
                <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                  <i class="fa-solid fa-spinner fa-spin"></i> <span data-i18n="inventory.loading">Cargando inventario...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Mensajes Programados -->
          <div class="table-container" id="scheduledSection" style="margin-top: 20px; display:none;">
            <div class="table-header">
              <h3 data-i18n="sched.title"><i class="fa-solid fa-clock"></i> Mensajes Programados</h3>
              <button class="btn btn-secondary btn-sm" onclick="loadScheduledMessages()" data-i18n="common.update">
                <i class="fa-solid fa-rotate"></i> Actualizar
              </button>
            </div>
            <div style="padding: 20px;">
              <!-- Formulario mejorado -->
              <div class="scheduled-form-card">
                <div class="scheduled-form-card-header">
                  <i class="fa-solid fa-calendar-plus"></i>
                  <span data-i18n="sched.create">Programar Mensaje</span>
                </div>
                <div class="scheduled-form">
                  <div class="scheduled-form-row">
                    <div class="scheduled-form-field" style="flex:1;">
                      <label data-i18n="sched.group"><i class="fa-solid fa-people-group"></i> Grupo de WhatsApp</label>
                      <div style="display:flex;gap:8px;">
                        <select id="scheduledGroupSelect" style="flex:1;">
                          <option value="" data-i18n="sched.loading_groups">Cargando grupos...</option>
                        </select>
                        <button class="btn btn-sm scheduled-refresh-btn" onclick="loadGroups()" title="Recargar grupos">
                          <i class="fa-solid fa-rotate"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="scheduled-form-field">
                    <label data-i18n="sched.message"><i class="fa-solid fa-message"></i> Mensaje</label>
                    <textarea id="scheduledMessageText" rows="3" placeholder="Escribe el mensaje a enviar al grupo..." data-i18n-ph="sched.message_ph"></textarea>
                  </div>
                  <div class="scheduled-form-row">
                    <div class="scheduled-form-field" style="flex:1;">
                      <label data-i18n="sched.datetime"><i class="fa-regular fa-calendar"></i> Fecha y hora de env√≠o</label>
                      <input type="datetime-local" id="scheduledDateTime" />
                    </div>
                    <div class="scheduled-form-field" style="flex:1;">
                      <label data-i18n="sched.send_type"><i class="fa-solid fa-repeat"></i> Tipo de env√≠o</label>
                      <select id="scheduledType" onchange="toggleRecurringOptions()">
                        <option value="once" data-i18n="sched.once">Una sola vez</option>
                        <option value="recurring" data-i18n="sched.recurring">Repetir cada X tiempo</option>
                      </select>
                    </div>
                  </div>
                  <div class="scheduled-form-row" id="recurringOptions" style="display:none;">
                    <div class="scheduled-form-field" style="flex:1;">
                      <label data-i18n="sched.repeat_every"><i class="fa-solid fa-clock-rotate-left"></i> Repetir cada</label>
                      <input type="number" id="scheduledInterval" min="1" value="60" />
                    </div>
                    <div class="scheduled-form-field" style="flex:1;">
                      <label data-i18n="sched.unit">Unidad</label>
                      <select id="scheduledIntervalUnit">
                        <option value="minutes" data-i18n="sched.minutes">Minutos</option>
                        <option value="hours" data-i18n="sched.hours">Horas</option>
                        <option value="days" data-i18n="sched.days">D√≠as</option>
                      </select>
                    </div>
                  </div>
                  <button class="btn scheduled-create-btn" onclick="createScheduledMessage()">
                    <i class="fa-solid fa-paper-plane"></i> <span data-i18n="sched.create">Programar Mensaje</span>
                  </button>
                </div>
              </div>
              <!-- Lista de mensajes programados -->
              <div id="scheduledList" style="margin-top: 20px;">
                <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                  <i class="fa-solid fa-calendar-xmark"></i>
                  <p data-i18n="sched.empty">Sin mensajes programados</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Conversaciones Activas -->
          <div class="table-container" style="margin-top: 20px;">
            <div class="table-header">
              <h3 data-i18n="conv.title"><i class="fa-solid fa-comments"></i> Conversaciones Activas</h3>
              <button class="btn btn-secondary btn-sm" onclick="loadConversations()" data-i18n="common.update">
                <i class="fa-solid fa-rotate"></i> Actualizar
              </button>
            </div>
            <div class="conv-layout">
              <!-- Lista de conversaciones -->
              <div class="conv-list" id="convList">
                <div class="conv-list-empty">
                  <i class="fa-solid fa-inbox"></i>
                  <p data-i18n="conv.empty">Sin conversaciones a√∫n</p>
                  <small data-i18n="conv.empty_desc">Los chats aparecer√°n aqu√≠ cuando lleguen mensajes</small>
                </div>
              </div>
              <!-- Vista del chat -->
              <div class="conv-chat" id="convChat">
                <div class="conv-chat-placeholder">
                  <i class="fa-solid fa-message"></i>
                  <p data-i18n="conv.select">Selecciona una conversaci√≥n</p>
                  <small data-i18n="conv.select_desc">Haz clic en un chat para ver los mensajes y responder</small>
                </div>
                <!-- Header del chat (oculto inicialmente) -->
                <div class="conv-chat-header" id="convChatHeader" style="display:none;">
                  <div class="conv-chat-header-info">
                    <div class="conv-chat-avatar" id="convChatAvatar">
                      <i class="fa-solid fa-user"></i>
                    </div>
                    <div>
                      <strong id="convChatName">‚Äî</strong>
                      <small id="convChatPhone">‚Äî</small>
                    </div>
                  </div>
                  <div class="conv-chat-header-actions">
                    <button class="btn btn-secondary btn-sm" id="convPauseBtn" onclick="toggleConvPause()" title="Pausar/Reanudar bot">
                      <i class="fa-solid fa-pause"></i> <span id="convPauseLabel" data-i18n="conv.pause">Pausar</span>
                    </button>
                  </div>
                </div>
                <!-- Mensajes -->
                <div class="conv-messages" id="convMessages" style="display:none;"></div>
                <!-- Input de respuesta -->
                <div class="conv-reply" id="convReply" style="display:none;">
                  <input type="text" id="convReplyInput" class="form-control" placeholder="Escribe una respuesta..." data-i18n-ph="conv.reply_ph" onkeydown="if(event.key==='Enter')sendConvReply()" />
                  <button class="btn btn-primary" onclick="sendConvReply()">
                    <i class="fa-solid fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Test del bot -->
          <div class="table-container" style="margin-top: 20px;" id="chatbotTestSection" hidden>
            <div class="table-header">
              <h3 data-i18n="test.title"><i class="fa-solid fa-flask"></i> Probar Chatbot</h3>
            </div>
            <div style="padding: 20px;">
              <div id="chatTestMessages" class="chat-test-messages"></div>
              <div style="display: flex; gap: 8px; margin-top: 12px;">
                <input type="text" id="chatTestInput" class="form-control" placeholder="Escribe un mensaje de prueba..." data-i18n-ph="test.ph" style="flex:1;" onkeydown="if(event.key==='Enter')sendTestMessage()" />
                <button class="btn btn-primary" onclick="sendTestMessage()">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- ============================================================
       MODALES
       ============================================================ -->

  <!-- Modal: Nueva Cuenta -->
  <div class="modal-overlay" id="accountModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="accountModalTitle" data-i18n="modal.new_account"><i class="fa-solid fa-tv"></i> Nueva Cuenta</h3>
        <button class="modal-close" onclick="closeModal('accountModal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="accountForm" onsubmit="saveAccount(event)">
          <input type="hidden" id="accountId" />

          <div class="form-group">
            <label for="accountPlatform" data-i18n="modal.platform">Plataforma</label>
            <select id="accountPlatform" class="form-control" required onchange="toggleCustomPlatform()">
              <option value="" data-i18n="modal.select_platform">Seleccionar plataforma</option>
              <option value="Netflix">Netflix</option>
              <option value="Disney+">Disney+</option>
              <option value="HBO Max">HBO Max</option>
              <option value="Spotify">Spotify</option>
              <option value="Amazon Prime">Amazon Prime</option>
              <option value="Crunchyroll">Crunchyroll</option>
              <option value="YouTube Premium">YouTube Premium</option>
              <option value="Paramount+">Paramount+</option>
              <option value="Apple TV+">Apple TV+</option>
              <option value="Star+">Star+</option>
              <option value="__custom__" data-i18n="modal.other_manual">Otro (escribir manualmente)</option>
            </select>
            <input type="text" id="accountPlatformCustom" class="form-control" placeholder="Nombre de la plataforma" data-i18n-ph="modal.platform_name_ph" style="display:none; margin-top:8px;" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="accountEmail" data-i18n="modal.account_email">Correo de la cuenta</label>
              <input type="email" id="accountEmail" class="form-control" placeholder="cuenta@email.com" data-i18n-ph="modal.account_email_ph" required />
            </div>
            <div class="form-group">
              <label for="accountPassword" data-i18n="modal.account_password">Contrase√±a</label>
              <input type="text" id="accountPassword" class="form-control" placeholder="contrase√±a123" data-i18n-ph="modal.account_password_ph" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="accountProfiles" data-i18n="modal.total_profiles">Perfiles totales</label>
              <input type="number" id="accountProfiles" class="form-control" placeholder="5" min="1" max="10" required />
            </div>
            <div class="form-group">
              <label for="accountExpiry" data-i18n="modal.master_expiry">Vencimiento m√°ster</label>
              <input type="date" id="accountExpiry" class="form-control" required />
            </div>
          </div>

          <div class="form-group">
            <label for="accountPricePerProfile" data-i18n="modal.price_per_profile">Precio por perfil ($)</label>
            <input type="number" id="accountPricePerProfile" class="form-control" placeholder="Ej: 45" min="0" step="0.01" />
          </div>

          <div class="form-group">
            <label for="accountNotes" data-i18n="modal.notes">Notas (opcional)</label>
            <input type="text" id="accountNotes" class="form-control" placeholder="Ej: Plan familiar, compartido..." data-i18n-ph="modal.notes_ph" />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('accountModal')" data-i18n="modal.cancel">Cancelar</button>
        <button class="btn btn-primary" onclick="document.getElementById('accountForm').requestSubmit()" data-i18n="modal.save">
          <i class="fa-solid fa-floppy-disk"></i>
          Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Nuevo Cliente -->
  <div class="modal-overlay" id="clientModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="clientModalTitle" data-i18n="modal.new_client"><i class="fa-solid fa-user-plus"></i> Nuevo Cliente</h3>
        <button class="modal-close" onclick="closeModal('clientModal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="clientForm" onsubmit="saveClient(event)">
          <input type="hidden" id="clientId" />

          <div class="form-row">
            <div class="form-group">
              <label for="clientName" data-i18n="modal.full_name">Nombre completo</label>
              <input type="text" id="clientName" class="form-control" placeholder="Juan P√©rez" data-i18n-ph="modal.full_name_ph" required />
            </div>
            <div class="form-group">
              <label for="clientWhatsapp">WhatsApp</label>
              <input type="tel" id="clientWhatsapp" class="form-control" placeholder="+521234567890" required />
            </div>
          </div>

          <div class="form-group">
            <label for="clientAccount" data-i18n="modal.assigned_account">Cuenta asignada</label>
            <select id="clientAccount" class="form-control" required onchange="updateProfileOptions()">
              <option value="" data-i18n="modal.select_account">Seleccionar cuenta...</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="clientProfile" data-i18n="modal.assigned_profile">Perfil asignado</label>
              <input type="text" id="clientProfile" class="form-control" placeholder="Perfil 1" data-i18n-ph="modal.assigned_profile_ph" required />
            </div>
            <div class="form-group">
              <label for="clientPin">PIN</label>
              <input type="text" id="clientPin" class="form-control" placeholder="1234" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="clientStart" data-i18n="modal.start_date">Fecha inicio</label>
              <input type="date" id="clientStart" class="form-control" required />
            </div>
            <div class="form-group">
              <label for="clientEnd" data-i18n="modal.end_date">Fecha fin</label>
              <input type="date" id="clientEnd" class="form-control" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="clientPrice" data-i18n="modal.price">Precio</label>
              <input type="number" id="clientPrice" class="form-control" placeholder="0" min="0" step="1" />
            </div>
            <div class="form-group">
              <label for="clientPaymentStatus" data-i18n="modal.payment_status">Estado de pago</label>
              <select id="clientPaymentStatus" class="form-control">
                <option value="pagado" data-i18n="modal.paid">Pagado</option>
                <option value="pendiente" data-i18n="modal.pending">Pendiente</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('clientModal')" data-i18n="modal.cancel">Cancelar</button>
        <button class="btn btn-primary" onclick="document.getElementById('clientForm').requestSubmit()" data-i18n="modal.save">
          <i class="fa-solid fa-floppy-disk"></i>
          Guardar
        </button>
        <button class="btn" id="btnSaveAndSendCreds" style="background: var(--whatsapp); color: #fff; display: none;" onclick="saveAndSendCredentials()" data-i18n="modal.save_send_creds">
          <i class="fa-brands fa-whatsapp"></i>
          Guardar y Enviar Credenciales
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Nuevo Movimiento -->
  <div class="modal-overlay" id="movementModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="movementModalTitle" data-i18n="modal.new_movement"><i class="fa-solid fa-receipt"></i> Nuevo Movimiento</h3>
        <button class="modal-close" onclick="closeModal('movementModal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="movementForm" onsubmit="saveMovement(event)">
          <input type="hidden" id="movementId" />

          <div class="form-group">
            <label for="movementClient" data-i18n="th.client">Cliente</label>
            <select id="movementClient" class="form-control" required>
              <option value="" data-i18n="modal.select_client">Seleccionar cliente...</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="movementAmount" data-i18n="modal.amount">Monto</label>
              <input type="number" id="movementAmount" class="form-control" placeholder="0.00" step="0.01" min="0" required />
            </div>
            <div class="form-group">
              <label for="movementDate" data-i18n="modal.payment_date">Fecha de pago</label>
              <input type="date" id="movementDate" class="form-control" required />
            </div>
          </div>

          <div class="form-group">
            <label for="movementMethod" data-i18n="modal.payment_method">M√©todo de pago</label>
            <select id="movementMethod" class="form-control" required>
              <option value="" data-i18n="modal.select_method">Seleccionar m√©todo...</option>
              <option value="Efectivo" data-i18n="modal.cash">Efectivo</option>
              <option value="Transferencia" data-i18n="modal.transfer">Transferencia</option>
              <option value="Nequi">Nequi</option>
              <option value="Daviplata">Daviplata</option>
              <option value="PayPal">PayPal</option>
              <option value="Otro" data-i18n="modal.other">Otro</option>
            </select>
          </div>

          <div class="form-group">
            <label for="movementNote" data-i18n="modal.notes">Nota (opcional)</label>
            <input type="text" id="movementNote" class="form-control" placeholder="Ej: Pago mes de febrero" data-i18n-ph="modal.note_ph" />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('movementModal')" data-i18n="modal.cancel">Cancelar</button>
        <button class="btn btn-primary" onclick="document.getElementById('movementForm').requestSubmit()" data-i18n="modal.save">
          <i class="fa-solid fa-floppy-disk"></i>
          Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Editar Mensaje Programado -->
  <div class="modal-overlay" id="editScheduledModal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header">
        <h3><i class="fa-solid fa-pen-to-square"></i> <span data-i18n="sched.edit_title">Editar Mensaje Programado</span></h3>
        <button class="modal-close" onclick="closeModal('editScheduledModal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editSchedId" />
        <div class="form-group">
          <label data-i18n="sched.group"><i class="fa-solid fa-people-group"></i> Grupo</label>
          <input type="text" id="editSchedGroup" class="form-control" disabled />
        </div>
        <div class="form-group">
          <label data-i18n="sched.message"><i class="fa-solid fa-message"></i> Mensaje</label>
          <textarea id="editSchedMessage" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label data-i18n="sched.datetime"><i class="fa-regular fa-calendar"></i> Fecha y hora</label>
            <input type="datetime-local" id="editSchedDateTime" class="form-control" />
          </div>
          <div class="form-group">
            <label data-i18n="sched.send_type"><i class="fa-solid fa-repeat"></i> Tipo de env√≠o</label>
            <select id="editSchedType" class="form-control" onchange="toggleEditRecurringOptions()">
              <option value="once" data-i18n="sched.once">Una sola vez</option>
              <option value="recurring" data-i18n="sched.recurring">Repetir</option>
            </select>
          </div>
        </div>
        <div class="form-row" id="editRecurringOptions" style="display:none;">
          <div class="form-group">
            <label data-i18n="sched.repeat_every"><i class="fa-solid fa-clock-rotate-left"></i> Repetir cada</label>
            <input type="number" id="editSchedInterval" class="form-control" min="1" value="60" />
          </div>
          <div class="form-group">
            <label data-i18n="sched.unit">Unidad</label>
            <select id="editSchedIntervalUnit" class="form-control">
              <option value="minutes" data-i18n="sched.minutes">Minutos</option>
              <option value="hours" data-i18n="sched.hours">Horas</option>
              <option value="days" data-i18n="sched.days">D√≠as</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editScheduledModal')" data-i18n="modal.cancel">Cancelar</button>
        <button class="btn btn-primary" onclick="saveScheduledEdit()">
          <i class="fa-solid fa-floppy-disk"></i>
          <span data-i18n="modal.save">Guardar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Plantilla de mensaje -->
  <div class="modal-overlay" id="templateModal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header">
        <h3><i class="fa-solid fa-envelope-open-text"></i> <span id="templateModalTitle" data-i18n="templates.new">Nueva Plantilla</span></h3>
        <button class="modal-close" onclick="closeModal('templateModal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="templateId" />
        <div class="form-group">
          <label data-i18n="templates.name_label">Nombre</label>
          <input type="text" id="templateName" class="form-control" placeholder="Ej: Cobro mensual" />
        </div>
        <div class="form-group">
          <label data-i18n="templates.type_label">Tipo</label>
          <select id="templateType" class="form-control">
            <option value="cobro">Cobro / Recordatorio</option>
            <option value="bienvenida">Bienvenida</option>
            <option value="renovacion">Renovaci√≥n</option>
            <option value="custom">Personalizado</option>
          </select>
        </div>
        <div class="form-group">
          <label data-i18n="templates.message_label">Mensaje</label>
          <textarea id="templateMessage" class="form-control" rows="5" placeholder="Hola {nombre}, tu suscripci√≥n de {plataforma} vence el {vencimiento}..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('templateModal')" data-i18n="modal.cancel">Cancelar</button>
        <button class="btn btn-primary" onclick="saveTemplate()">
          <i class="fa-solid fa-floppy-disk"></i>
          <span data-i18n="modal.save">Guardar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Historial de pagos de cliente -->
  <div class="modal-overlay" id="historyModal">
    <div class="modal" style="max-width: 620px;">
      <div class="modal-header">
        <h3><i class="fa-solid fa-clock-rotate-left"></i> <span data-i18n="clients.history">Historial de Pagos</span></h3>
        <button class="modal-close" onclick="closeModal('historyModal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="historyClientName" style="font-weight:600;font-size:1.1rem;margin-bottom:12px;"></div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th data-i18n="modal.payment_date">Fecha</th>
                <th data-i18n="modal.amount">Monto</th>
                <th data-i18n="modal.payment_method">M√©todo</th>
                <th data-i18n="modal.notes">Nota</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <tr><td colspan="4" class="table-empty">Sin registros</td></tr>
            </tbody>
          </table>
        </div>
        <div id="historyTotal" style="text-align:right;font-weight:600;margin-top:12px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('historyModal')" data-i18n="modal.close">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Detalle del d√≠a del calendario -->
  <div class="modal-overlay" id="calendarDayModal">
    <div class="modal" style="max-width: 580px;">
      <div class="modal-header">
        <h3 id="calendarDayModalTitle"><i class="fa-solid fa-calendar-day"></i> Detalle del d√≠a</h3>
        <button class="modal-close" onclick="closeModal('calendarDayModal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body" id="calendarDayModalBody" style="max-height: 60vh; overflow-y: auto;">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('calendarDayModal')">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Confirmaci√≥n de eliminaci√≥n -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 data-i18n="modal.confirm"><i class="fa-solid fa-triangle-exclamation" style="color: var(--danger);"></i> Confirmar</h3>
        <button class="modal-close" onclick="closeModal('confirmModal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="confirm-dialog">
          <i class="fa-solid fa-trash-can"></i>
          <h4 id="confirmTitle" data-i18n="modal.confirm_delete">¬øEliminar este registro?</h4>
          <p id="confirmMessage" data-i18n="modal.confirm_msg">Esta acci√≥n no se puede deshacer.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('confirmModal')" data-i18n="modal.cancel">Cancelar</button>
        <button class="btn btn-danger" id="confirmDeleteBtn" data-i18n="modal.delete">
          <i class="fa-solid fa-trash-can"></i>
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <!-- TOAST Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- ============================================================
       SCRIPTS
       ============================================================ -->
  <!-- Chart.js (lazy ‚Äî se carga despu√©s del render inicial) -->
  <script>
    // Lazy load Chart.js solo cuando se necesite
    window._chartLoaded = false;
    function loadChartJS() {
      if (window._chartLoaded) return Promise.resolve();
      return new Promise(r => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
        s.onload = () => { window._chartLoaded = true; r(); };
        document.head.appendChild(s);
      });
    }
  </script>

  <!-- Firebase SDK (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- App Scripts -->
  <script src="js/firebase-config.js"></script>
  <script src="js/i18n.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
